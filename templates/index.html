<!DOCTYPE html>
<html>
<head>
    <title>Phishing Scan History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <h2>Phishing Scan History</h2>

    <!-- Time Filter Buttons -->
    <div class="btn-group mb-3" role="group">
        <a href="{{ url_for('scan_history', since='1hr') }}" class="btn btn-sm btn-outline-secondary {% if since == '1hr' %}active{% endif %}">Last 1 hr</a>
        <a href="{{ url_for('scan_history', since='24hr') }}" class="btn btn-sm btn-outline-secondary {% if since == '24hr' %}active{% endif %}">Last 24 hr</a>
        <a href="{{ url_for('scan_history', since='7day') }}" class="btn btn-sm btn-outline-secondary {% if since == '7day' %}active{% endif %}">Last 7 days</a>
        <a href="{{ url_for('scan_history') }}" class="btn btn-sm btn-outline-secondary {% if not since %}active{% endif %}">All Time</a>
    </div>

    <!-- Search/Filter/Export -->
    <form method="get" class="row g-2 mb-3">
        <div class="col-md-4">
            <input type="text" class="form-control" name="search" placeholder="Search by sender or subject" value="{{ search }}">
        </div>
        <div class="col-md-3">
            <select name="filter_phish" class="form-select">
                <option value="all" {% if filter_phish == 'all' %}selected{% endif %}>All</option>
                <option value="phishing" {% if filter_phish == 'phishing' %}selected{% endif %}>Phishing Only</option>
                <option value="safe" {% if filter_phish == 'safe' %}selected{% endif %}>Safe Only</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary">Filter</button>
        </div>
        <div class="col-md-3 text-end">
            <a href="{{ url_for('export_csv') }}" class="btn btn-success">Export CSV</a>
        </div>
    </form>

    {% if deleted_id %}
    <div class="alert alert-warning">
        Deleted! <form method="post" action="{{ url_for('undo_delete', scan_id=deleted_id) }}" style="display:inline;">
            <button type="submit" class="btn btn-link">Undo</button>
        </form>
    </div>
    {% endif %}

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Sender</th>
                <th>Subject</th>
                <th>Scan Time</th>
                <th>Phishing?</th>
                <th>Threat Score</th>
                <th>Recommendations</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for record in records.items %}
            <tr>
                <td>{{ record.sender }}</td>
                <td>{{ record.subject }}</td>
                <td>{{ record.scanned_at }}</td>
                <td>
                    {% if record.is_phishing %}
                        <span style="color:red;font-weight:bold;">YES</span>
                    {% else %}
                        <span style="color:green;">No</span>
                    {% endif %}
                </td>
                <td>{{ record.threat_score or 'N/A' }}</td>
                <td><pre style="font-size: 0.95em;">{{ record.recommendations or '' }}</pre></td>
                <td>
                    {% if not record.deleted %}
                    <form method="post" action="{{ url_for('delete_scan', scan_id=record.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if records.has_prev %}
            <li class="page-item"><a class="page-link" href="?page={{ records.prev_num }}&search={{ search }}&filter_phish={{ filter_phish }}&since={{ since }}">Previous</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}
            {% if records.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ records.next_num }}&search={{ search }}&filter_phish={{ filter_phish }}&since={{ since }}">Next</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>

</div>
</body>
</html>